---
title: A closer look at the train/test split for machine learning
author: Amanda
date: '2020-11-08'
slug: what-exactly-are-we-testing-a-closer-look-at-the-train-test-split
categories:
  - Machine Learning
draft: false
tags: [ml]
output:
  blogdown::html_page:
#    theme: cerulean
    toc: false
#    toc_float: true
#    toc_depth: 1
#    number_sections: true
#    code_folding: show
#    includes:
#      in_header: header_github.html
---

<link href="{{< relref "post/2020-11-08-what-exactly-are-we-testig-a-closer-look-at-the-train-test-split/index.html" >}}index_files/anchor-sections/anchor-sections.css" rel="stylesheet" />
<script src="{{< relref "post/2020-11-08-what-exactly-are-we-testig-a-closer-look-at-the-train-test-split/index.html" >}}index_files/anchor-sections/anchor-sections.js"></script>


<p>In the paper <a href="https://arxiv.org/pdf/1907.06902.pdf">Are We Really Making Much Progress? A Worrying Analysis of Recent Neural Recommendation Approaches</a>, authors Dacrema, Cremonesi, and Jannach evaluate various neural networks which were designed for recommendation systems and proposed in prominent machine learning journals. A recommendation system is an information filtering system which uses user history (e.g. purchases, page views, clicks, thumbs up/down, etc) to provide personalized item recommendations to users.</p>
<p>The authors point out a few mistakes or “questionable techniques” used in the research they were attempting to reproduce and evaluate. The figure in the article snippet below points out that, for a particular model they were evaluating, the popularity distribution of items assigned to the test and train data splits did not seem to be the same. <em>Interestingly, this affected the reported results and potentially the claim that the proposed model was a state-of-the-art!</em> See the article for more details.</p>
<hr />
<center>
<p><img width=48%" src="images/para1.png"/>
<img width="48%" src="images/para2.png"/></p>
Snippet of the 2020 paper, “Are We Really Making Much Progress? A Worrying Analysis of Recent Neural Recommendation Approaches”, by Dacrema, Cremonesi, and Jannach
</center>
<hr />
<p>I thought this was a nice example comparing the distribution of two samples (i.e. comparing the item popularity of the test set versus the training set). Why is this important? Well, because we would like to train our model using data similar that which the model will score in the future. The test set is used to tell us how good (or bad) our model performs on data that it has not seen before.</p>
<p>The authors mentioned that they used the Gini index to evaluate the distribution of the test set. One might also wonder if a hypothesis test could be used to consider the evidence for or against the training and test sets having the same underlying distribution. Let’s look at both approaches.</p>
<div id="the-data" class="section level2">
<h2>The data</h2>
<p>The train and test data mentioned in the article above are available at <a href="https://github.com/lzheng21/SpectralCF/tree/master/data/ml-1m">github.com/lzheng21/SpectralCF</a>.
For convenience I also saved them as R dataframes in the <a href="https://github.com/AmandaRP/AmandaRP.github.io/tree/master/content/post/2020-11-08-what-exactly-are-we-testig-a-closer-look-at-the-train-test-split/data">data directory</a> of the GitHub repo associated with this analysis. Using R, the data can be loaded as follows.</p>
<pre class="r fold-show"><code>load(&quot;data/train_test.RData&quot;)</code></pre>
<p>Let’s take a peak at the training set. The data is composed of two columns containing user id’s and item id’s. It comes from <a href="https://grouplens.org/datasets/movielens/">MovieLens</a>, which provides data about user movie watching history. The existence of user-item pair in the data means that the user interacted with the item (in this case the user watched the movie). A data scientist can use this information as “implicit feedback”, inferring that the user “liked” the item.</p>
<p><br></p>
<style>html {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Helvetica Neue', 'Fira Sans', 'Droid Sans', Arial, sans-serif;
}

#njnmjmjbtc .gt_table {
  display: table;
  border-collapse: collapse;
  margin-left: auto;
  margin-right: auto;
  color: #333333;
  font-size: 16px;
  font-weight: normal;
  font-style: normal;
  background-color: #FFFFFF;
  width: auto;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #A8A8A8;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #A8A8A8;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
}

#njnmjmjbtc .gt_heading {
  background-color: #FFFFFF;
  text-align: center;
  border-bottom-color: #FFFFFF;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#njnmjmjbtc .gt_title {
  color: #333333;
  font-size: 125%;
  font-weight: initial;
  padding-top: 4px;
  padding-bottom: 4px;
  border-bottom-color: #FFFFFF;
  border-bottom-width: 0;
}

#njnmjmjbtc .gt_subtitle {
  color: #333333;
  font-size: 85%;
  font-weight: initial;
  padding-top: 0;
  padding-bottom: 4px;
  border-top-color: #FFFFFF;
  border-top-width: 0;
}

#njnmjmjbtc .gt_bottom_border {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#njnmjmjbtc .gt_col_headings {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#njnmjmjbtc .gt_col_heading {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  padding-left: 5px;
  padding-right: 5px;
  overflow-x: hidden;
}

#njnmjmjbtc .gt_column_spanner_outer {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  padding-top: 0;
  padding-bottom: 0;
  padding-left: 4px;
  padding-right: 4px;
}

#njnmjmjbtc .gt_column_spanner_outer:first-child {
  padding-left: 0;
}

#njnmjmjbtc .gt_column_spanner_outer:last-child {
  padding-right: 0;
}

#njnmjmjbtc .gt_column_spanner {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  overflow-x: hidden;
  display: inline-block;
  width: 100%;
}

#njnmjmjbtc .gt_group_heading {
  padding: 8px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
}

#njnmjmjbtc .gt_empty_group_heading {
  padding: 0.5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: middle;
}

#njnmjmjbtc .gt_from_md > :first-child {
  margin-top: 0;
}

#njnmjmjbtc .gt_from_md > :last-child {
  margin-bottom: 0;
}

#njnmjmjbtc .gt_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  margin: 10px;
  border-top-style: solid;
  border-top-width: 1px;
  border-top-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  overflow-x: hidden;
}

#njnmjmjbtc .gt_stub {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 12px;
}

#njnmjmjbtc .gt_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#njnmjmjbtc .gt_first_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
}

#njnmjmjbtc .gt_grand_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#njnmjmjbtc .gt_first_grand_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: double;
  border-top-width: 6px;
  border-top-color: #D3D3D3;
}

#njnmjmjbtc .gt_striped {
  background-color: rgba(128, 128, 128, 0.05);
}

#njnmjmjbtc .gt_table_body {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#njnmjmjbtc .gt_footnotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#njnmjmjbtc .gt_footnote {
  margin: 0px;
  font-size: 90%;
  padding: 4px;
}

#njnmjmjbtc .gt_sourcenotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#njnmjmjbtc .gt_sourcenote {
  font-size: 90%;
  padding: 4px;
}

#njnmjmjbtc .gt_left {
  text-align: left;
}

#njnmjmjbtc .gt_center {
  text-align: center;
}

#njnmjmjbtc .gt_right {
  text-align: right;
  font-variant-numeric: tabular-nums;
}

#njnmjmjbtc .gt_font_normal {
  font-weight: normal;
}

#njnmjmjbtc .gt_font_bold {
  font-weight: bold;
}

#njnmjmjbtc .gt_font_italic {
  font-style: italic;
}

#njnmjmjbtc .gt_super {
  font-size: 65%;
}

#njnmjmjbtc .gt_footnote_marks {
  font-style: italic;
  font-size: 65%;
}
</style>
<div id="njnmjmjbtc" style="overflow-x:auto;overflow-y:auto;width:auto;height:auto;"><table class="gt_table">
  <thead class="gt_header">
    <tr>
      <th colspan="2" class="gt_heading gt_title gt_font_normal" style>Sample of Training Data</th>
    </tr>
    <tr>
      <th colspan="2" class="gt_heading gt_subtitle gt_font_normal gt_bottom_border" style></th>
    </tr>
  </thead>
  <thead class="gt_col_headings">
    <tr>
      <th class="gt_col_heading gt_columns_bottom_border gt_center" rowspan="1" colspan="1">user</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_center" rowspan="1" colspan="1">item</th>
    </tr>
  </thead>
  <tbody class="gt_table_body">
    <tr>
      <td class="gt_row gt_center">1702</td>
      <td class="gt_row gt_center">1497</td>
    </tr>
    <tr>
      <td class="gt_row gt_center">786</td>
      <td class="gt_row gt_center">132</td>
    </tr>
    <tr>
      <td class="gt_row gt_center">1892</td>
      <td class="gt_row gt_center">279</td>
    </tr>
    <tr>
      <td class="gt_row gt_center">4333</td>
      <td class="gt_row gt_center">317</td>
    </tr>
    <tr>
      <td class="gt_row gt_center">4962</td>
      <td class="gt_row gt_center">220</td>
    </tr>
  </tbody>
  
  
</table></div>
<p><br></p>
<style>html {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Helvetica Neue', 'Fira Sans', 'Droid Sans', Arial, sans-serif;
}

#ayatmxojyo .gt_table {
  display: table;
  border-collapse: collapse;
  margin-left: auto;
  margin-right: auto;
  color: #333333;
  font-size: 16px;
  font-weight: normal;
  font-style: normal;
  background-color: #FFFFFF;
  width: auto;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #A8A8A8;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #A8A8A8;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
}

#ayatmxojyo .gt_heading {
  background-color: #FFFFFF;
  text-align: center;
  border-bottom-color: #FFFFFF;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#ayatmxojyo .gt_title {
  color: #333333;
  font-size: 125%;
  font-weight: initial;
  padding-top: 4px;
  padding-bottom: 4px;
  border-bottom-color: #FFFFFF;
  border-bottom-width: 0;
}

#ayatmxojyo .gt_subtitle {
  color: #333333;
  font-size: 85%;
  font-weight: initial;
  padding-top: 0;
  padding-bottom: 4px;
  border-top-color: #FFFFFF;
  border-top-width: 0;
}

#ayatmxojyo .gt_bottom_border {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#ayatmxojyo .gt_col_headings {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#ayatmxojyo .gt_col_heading {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  padding-left: 5px;
  padding-right: 5px;
  overflow-x: hidden;
}

#ayatmxojyo .gt_column_spanner_outer {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  padding-top: 0;
  padding-bottom: 0;
  padding-left: 4px;
  padding-right: 4px;
}

#ayatmxojyo .gt_column_spanner_outer:first-child {
  padding-left: 0;
}

#ayatmxojyo .gt_column_spanner_outer:last-child {
  padding-right: 0;
}

#ayatmxojyo .gt_column_spanner {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  overflow-x: hidden;
  display: inline-block;
  width: 100%;
}

#ayatmxojyo .gt_group_heading {
  padding: 8px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
}

#ayatmxojyo .gt_empty_group_heading {
  padding: 0.5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: middle;
}

#ayatmxojyo .gt_from_md > :first-child {
  margin-top: 0;
}

#ayatmxojyo .gt_from_md > :last-child {
  margin-bottom: 0;
}

#ayatmxojyo .gt_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  margin: 10px;
  border-top-style: solid;
  border-top-width: 1px;
  border-top-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  overflow-x: hidden;
}

#ayatmxojyo .gt_stub {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 12px;
}

#ayatmxojyo .gt_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#ayatmxojyo .gt_first_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
}

#ayatmxojyo .gt_grand_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#ayatmxojyo .gt_first_grand_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: double;
  border-top-width: 6px;
  border-top-color: #D3D3D3;
}

#ayatmxojyo .gt_striped {
  background-color: rgba(128, 128, 128, 0.05);
}

#ayatmxojyo .gt_table_body {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#ayatmxojyo .gt_footnotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#ayatmxojyo .gt_footnote {
  margin: 0px;
  font-size: 90%;
  padding: 4px;
}

#ayatmxojyo .gt_sourcenotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#ayatmxojyo .gt_sourcenote {
  font-size: 90%;
  padding: 4px;
}

#ayatmxojyo .gt_left {
  text-align: left;
}

#ayatmxojyo .gt_center {
  text-align: center;
}

#ayatmxojyo .gt_right {
  text-align: right;
  font-variant-numeric: tabular-nums;
}

#ayatmxojyo .gt_font_normal {
  font-weight: normal;
}

#ayatmxojyo .gt_font_bold {
  font-weight: bold;
}

#ayatmxojyo .gt_font_italic {
  font-style: italic;
}

#ayatmxojyo .gt_super {
  font-size: 65%;
}

#ayatmxojyo .gt_footnote_marks {
  font-style: italic;
  font-size: 65%;
}
</style>
<div id="ayatmxojyo" style="overflow-x:auto;overflow-y:auto;width:auto;height:auto;"><table class="gt_table">
  <thead class="gt_header">
    <tr>
      <th colspan="6" class="gt_heading gt_title gt_font_normal" style>Summary of Training Data</th>
    </tr>
    <tr>
      <th colspan="6" class="gt_heading gt_subtitle gt_font_normal gt_bottom_border" style></th>
    </tr>
  </thead>
  <thead class="gt_col_headings">
    <tr>
      <th class="gt_col_heading gt_columns_bottom_border gt_center" rowspan="1" colspan="1">Min User ID</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_center" rowspan="1" colspan="1">Max User ID</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_center" rowspan="1" colspan="1">User Count</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_center" rowspan="1" colspan="1">Min Item ID</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_center" rowspan="1" colspan="1">Max Item ID</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_center" rowspan="1" colspan="1">Item Count</th>
    </tr>
  </thead>
  <tbody class="gt_table_body">
    <tr>
      <td class="gt_row gt_center">0</td>
      <td class="gt_row gt_center">6013</td>
      <td class="gt_row gt_center">6014</td>
      <td class="gt_row gt_center">0</td>
      <td class="gt_row gt_center">3704</td>
      <td class="gt_row gt_center">3068</td>
    </tr>
  </tbody>
  
  
</table></div>
<p><br></p>
<p>Next, count the number of user interactions per item in each of the train and test datasets. Only the first 6 rows of the result are shown in the table below.</p>
<pre class="r fold-show"><code>item_frequency &lt;- 
  full_join(
    train %&gt;% group_by(item) %&gt;% count() %&gt;% ungroup(),
    test  %&gt;% group_by(item) %&gt;% count() %&gt;% ungroup(),
    by = &quot;item&quot;
  ) %&gt;%
  rename(count_train = n.x, count_test = n.y) %&gt;%
  replace_na(list(count_train = 0, count_test = 0))</code></pre>
<style>html {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Helvetica Neue', 'Fira Sans', 'Droid Sans', Arial, sans-serif;
}

#nowzzblqqd .gt_table {
  display: table;
  border-collapse: collapse;
  margin-left: auto;
  margin-right: auto;
  color: #333333;
  font-size: 16px;
  font-weight: normal;
  font-style: normal;
  background-color: #FFFFFF;
  width: auto;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #A8A8A8;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #A8A8A8;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
}

#nowzzblqqd .gt_heading {
  background-color: #FFFFFF;
  text-align: center;
  border-bottom-color: #FFFFFF;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#nowzzblqqd .gt_title {
  color: #333333;
  font-size: 125%;
  font-weight: initial;
  padding-top: 4px;
  padding-bottom: 4px;
  border-bottom-color: #FFFFFF;
  border-bottom-width: 0;
}

#nowzzblqqd .gt_subtitle {
  color: #333333;
  font-size: 85%;
  font-weight: initial;
  padding-top: 0;
  padding-bottom: 4px;
  border-top-color: #FFFFFF;
  border-top-width: 0;
}

#nowzzblqqd .gt_bottom_border {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#nowzzblqqd .gt_col_headings {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#nowzzblqqd .gt_col_heading {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  padding-left: 5px;
  padding-right: 5px;
  overflow-x: hidden;
}

#nowzzblqqd .gt_column_spanner_outer {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  padding-top: 0;
  padding-bottom: 0;
  padding-left: 4px;
  padding-right: 4px;
}

#nowzzblqqd .gt_column_spanner_outer:first-child {
  padding-left: 0;
}

#nowzzblqqd .gt_column_spanner_outer:last-child {
  padding-right: 0;
}

#nowzzblqqd .gt_column_spanner {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  overflow-x: hidden;
  display: inline-block;
  width: 100%;
}

#nowzzblqqd .gt_group_heading {
  padding: 8px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
}

#nowzzblqqd .gt_empty_group_heading {
  padding: 0.5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: middle;
}

#nowzzblqqd .gt_from_md > :first-child {
  margin-top: 0;
}

#nowzzblqqd .gt_from_md > :last-child {
  margin-bottom: 0;
}

#nowzzblqqd .gt_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  margin: 10px;
  border-top-style: solid;
  border-top-width: 1px;
  border-top-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  overflow-x: hidden;
}

#nowzzblqqd .gt_stub {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 12px;
}

#nowzzblqqd .gt_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#nowzzblqqd .gt_first_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
}

#nowzzblqqd .gt_grand_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#nowzzblqqd .gt_first_grand_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: double;
  border-top-width: 6px;
  border-top-color: #D3D3D3;
}

#nowzzblqqd .gt_striped {
  background-color: rgba(128, 128, 128, 0.05);
}

#nowzzblqqd .gt_table_body {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#nowzzblqqd .gt_footnotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#nowzzblqqd .gt_footnote {
  margin: 0px;
  font-size: 90%;
  padding: 4px;
}

#nowzzblqqd .gt_sourcenotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#nowzzblqqd .gt_sourcenote {
  font-size: 90%;
  padding: 4px;
}

#nowzzblqqd .gt_left {
  text-align: left;
}

#nowzzblqqd .gt_center {
  text-align: center;
}

#nowzzblqqd .gt_right {
  text-align: right;
  font-variant-numeric: tabular-nums;
}

#nowzzblqqd .gt_font_normal {
  font-weight: normal;
}

#nowzzblqqd .gt_font_bold {
  font-weight: bold;
}

#nowzzblqqd .gt_font_italic {
  font-style: italic;
}

#nowzzblqqd .gt_super {
  font-size: 65%;
}

#nowzzblqqd .gt_footnote_marks {
  font-style: italic;
  font-size: 65%;
}
</style>
<div id="nowzzblqqd" style="overflow-x:auto;overflow-y:auto;width:auto;height:auto;"><table class="gt_table">
  
  <thead class="gt_col_headings">
    <tr>
      <th class="gt_col_heading gt_columns_bottom_border gt_center" rowspan="1" colspan="1">item</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_right" rowspan="1" colspan="1">Train Count</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_right" rowspan="1" colspan="1">Test Count</th>
    </tr>
  </thead>
  <tbody class="gt_table_body">
    <tr>
      <td class="gt_row gt_center">0</td>
      <td class="gt_row gt_right">932</td>
      <td class="gt_row gt_right">5</td>
    </tr>
    <tr>
      <td class="gt_row gt_center">1</td>
      <td class="gt_row gt_right">77</td>
      <td class="gt_row gt_right">0</td>
    </tr>
    <tr>
      <td class="gt_row gt_center">2</td>
      <td class="gt_row gt_right">259</td>
      <td class="gt_row gt_right">1</td>
    </tr>
    <tr>
      <td class="gt_row gt_center">3</td>
      <td class="gt_row gt_right">308</td>
      <td class="gt_row gt_right">2</td>
    </tr>
    <tr>
      <td class="gt_row gt_center">4</td>
      <td class="gt_row gt_right">309</td>
      <td class="gt_row gt_right">85</td>
    </tr>
    <tr>
      <td class="gt_row gt_center">5</td>
      <td class="gt_row gt_right">1186</td>
      <td class="gt_row gt_right">0</td>
    </tr>
  </tbody>
  
  
</table></div>
<p><br></p>
<p>We can use this information to re-create the plot from the paper:</p>
<details>
<p><summary>View code</summary></p>
<p></br></p>
<pre class="r"><code>item_frequency %&gt;%
  mutate(train = count_train/max(count_train), test = count_test/max(count_test)) %&gt;%
  arrange(desc(count_train)) %&gt;%
  mutate(train_rank = row_number()) %&gt;%
  select(-count_train, -count_test) %&gt;%
  pivot_longer(-c(item, train_rank), names_to = &quot;data&quot;, values_to = &quot;num_interactions&quot;) %&gt;%
  ggplot(aes(train_rank, num_interactions, group = data, color = data)) +
  geom_line() +
  geom_point() +
  xlab(&quot;Item Index&quot;) +
  ylab(&quot;Normalized number of interactions&quot;)</code></pre>
</details>
<div class="figure" style="text-align: center"><span id="fig:unnamed-chunk-9"></span>
<img src="{{< relref "post/2020-11-08-what-exactly-are-we-testig-a-closer-look-at-the-train-test-split/index.html" >}}index_files/figure-html/unnamed-chunk-9-1.png" alt="Comparison of the provided test and train data" width="672" />
<p class="caption">
Figure 1: Comparison of the provided test and train data
</p>
</div>
<p>I think that looks pretty close to the image in the article! As the authors point out, the items are sorted by their popularity in the training set (in descending order along the horizontal axis). The value of the (normalized) test popularity is also plotted for each item. We can see that the two distributions do not look similar. To be a bit more rigorous we can consider a few statistical procedures.</p>
</div>
<div id="gini-index" class="section level2">
<h2>Gini Index</h2>
<p>The article authors used the Gini index to evaluate the distribution of the provided test set. Let’s try it to see how it works. We’ll use the <a href="https://CRAN.R-project.org/package=ineq"><code>ineq</code></a> R package.</p>
<pre class="r fold-show"><code>#install.packages(&quot;ineq&quot;)
library(ineq)</code></pre>
<p>The Gini index is a measure of inequality ranging from 0 (equality) to 1 (no equality). For example, if there was no popularity bias in the dataset (i.e. all items had the same number of interactions), then the Gini index would be 0. That’s not the case since some movies were watched more than others. Let’s look at the Gini index for the provided train and test sets.</p>
<pre class="r fold-show"><code># Gini index for provided test set
gini_provided_test &lt;- 
  item_frequency %&gt;% 
  select(-item, -count_train) %&gt;%
  as.matrix() %&gt;%
  ineq(type=&quot;Gini&quot;)

# Gini index for provided train set
gini_provided_train &lt;- 
  item_frequency %&gt;% 
  select(-item, -count_test) %&gt;%
  as.matrix() %&gt;%
  ineq(type=&quot;Gini&quot;)

gini_provided_train</code></pre>
<pre><code>## [1] 0.7636983</code></pre>
<pre class="r fold-show"><code>gini_provided_test</code></pre>
<pre><code>## [1] 0.9044503</code></pre>
<p>The provided test set has a much higher Gini index than the train dataset (0.9 compared to 0.76). Is such a difference expected for a random train/test split? Keep reading.</p>
</div>
<div id="resampling-the-test-data" class="section level2">
<h2>Resampling the test data</h2>
<p>Let’s try sampling our own test set to see how that affects the Gini index. We’ll start with the full dataset, sampling at the same rate as the provided train/test split and stratifying by user.</p>
<pre class="r fold-show"><code># Determine percentage of data that should be sampled for test
(pct_test &lt;- nrow(test)/(nrow(test) + nrow(train)))</code></pre>
<pre><code>## [1] 0.2081349</code></pre>
<pre class="r fold-show"><code># Sample test set (stratify by user)
data_full &lt;- bind_rows(train,test)
test_new &lt;- 
  data_full %&gt;% 
  group_by(user) %&gt;%
  slice_sample(prop = pct_test) %&gt;%
  ungroup()

# Put remaining data in train:
train_new &lt;- anti_join(data_full, test_new)

# Recreate our interaction counts for each item:
item_frequency_new &lt;- 
  full_join(
    train_new %&gt;% group_by(item) %&gt;% count() %&gt;% ungroup(),
    test_new  %&gt;% group_by(item) %&gt;% count() %&gt;% ungroup(),
    by = &quot;item&quot;
  ) %&gt;%
  rename(count_train = n.x, count_test = n.y) %&gt;%
  replace_na(list(count_train = 0, count_test = 0))</code></pre>
<p>Let’s visualize the newly sampled train and test data, which we can compare to Figure 1.</p>
<details>
<p><summary>View code</summary></p>
<p></br></p>
<pre class="r"><code>item_frequency_new %&gt;%
  mutate(train = count_train/max(count_train), test = count_test/max(count_test)) %&gt;%
  arrange(desc(count_train)) %&gt;%
  mutate(train_rank = row_number()) %&gt;%
  select(-count_train, -count_test) %&gt;%
  pivot_longer(-c(item, train_rank), names_to = &quot;data&quot;, values_to = &quot;num_interactions&quot;) %&gt;%
  ggplot(aes(train_rank, num_interactions, group = data, color = data)) +
  geom_line() +
  geom_point() +
  xlab(&quot;Items&quot;) +
  ylab(&quot;Normalized number of interactions&quot;)</code></pre>
</details>
<div class="figure" style="text-align: center"><span id="fig:unnamed-chunk-15"></span>
<img src="{{< relref "post/2020-11-08-what-exactly-are-we-testig-a-closer-look-at-the-train-test-split/index.html" >}}index_files/figure-html/unnamed-chunk-15-1.png" alt="Comparison of our sampled test and train data" width="672" />
<p class="caption">
Figure 2: Comparison of our sampled test and train data
</p>
</div>
<p>The test and train popularity distributions look much closer!</p>
</div>
<div id="gini-index-revisited" class="section level2">
<h2>Gini Index Revisited</h2>
<p>Now we can revisit the Gini index for the re-sampled train/test split.</p>
<pre class="r fold-show"><code># Gini index for our sampled test set:
gini_ours_test &lt;- 
  item_frequency_new %&gt;% 
  select(-item, -count_train) %&gt;%
  as.matrix() %&gt;%
  ineq(type=&quot;Gini&quot;)
gini_ours_test</code></pre>
<pre><code>## [1] 0.7548327</code></pre>
<pre class="r fold-show"><code># Gini index for our sampled train set:
gini_ours_train &lt;- 
  item_frequency_new %&gt;% 
  select(-item, -count_test) %&gt;%
  as.matrix() %&gt;%
  ineq(type=&quot;Gini&quot;)

gini_ours_train</code></pre>
<pre><code>## [1] 0.7509395</code></pre>
<p>We see that our sampled test set has a Gini index (0.75) that is much closer to that of our sampled training dataset (0.75).</p>
<p>But, how much difference can we expect between the two sampled datasets that are representative of the same distribution? Is the observed difference in the provided datasets likely due to random sampling or some other reason? Let’s take a look at a couple of hypothesis tests.</p>
</div>
<div id="hypothesis-testing" class="section level2">
<h2>Hypothesis Testing</h2>
<div id="chi2-test-of-homogeneity" class="section level3">
<h3><span class="math inline">\(\chi^2\)</span> Test of Homogeneity</h3>
<!-- ### $\chi^2$ Goodness of Fit Test -->
<p>Let’s suppose that our null hypothesis is that the train and test sets have the <em>same</em> underlying distribution (vs the alternative hypothesis that they do not). We can consider the data as a 2 by 3232 contingency table (since there are 3232 items).
One might naively choose to run a <span class="math inline">\(\chi^2\)</span> test to test this hypothesis.</p>
<!-- Let's suppose that our null hypothesis is that the test set is representative of the full dataset (vs the alternative hypothesis that it is not). We can consider the data as a 2 by 3232 contingency table (since there are 3232 items). -->
<!-- One might naively choose to run a $\chi^2$ test to test this hypothesis.  -->
<p>The <span class="math inline">\(\chi^2\)</span> test is most appropriate when the data is not too sparse. Recall that one of the rule-of-thumb assumptions for the <span class="math inline">\(\chi^2\)</span> test is that no more than 20% of the expected cells counts are less than 5. (Sometimes a slightly different rule of thumb is used: that <em>all</em> cell counts have an expected value of <em>at least</em> 5.) Let’s check to see if this assumption is satisfied.</p>
<pre class="r fold-show"><code># Check to see percentage of expected cell values are &lt; 5

# Compute the expected values
n_train &lt;- sum(item_frequency$count_train)
n_test &lt;- sum(item_frequency$count_test) 
n &lt;- n_train + n_test
item_frequency %&lt;&gt;% 
  mutate(p = (count_train + count_test)/n,
         e_test = p * n_test,
         e_train = p * n_train)

# Check what percentage of the expected values are less than 5
(pct_expected_small &lt;- sum((item_frequency$e_test &lt; 5) + (item_frequency$e_test &lt; 5))/(2*nrow(item_frequency)))</code></pre>
<pre><code>## [1] 0.5792079</code></pre>
<p>We see here that 57.9% of the expected values are very small (less than 5), meaning that the assumption in question is <strong>not</strong> satisfied.</p>
<!-- In addition to this issue, the test and train vectors are not independent. (The test/train split is a random partition of the full dataset. The data assigned to one of the sets is dependent on the data that is sampled for the other.) Independence is another assumption for the $\chi^2$ test. -->
<p>Let’s look at an alternative method.</p>
</div>
<div id="fishers-exact-test" class="section level3">
<h3>Fisher’s Exact Test</h3>
<p>Again consider a 2 by 3232 contingency table composed of the test and train vectors. We can utilize a test that is acceptable for small sample sizes: Fisher’s exact test can be used to test the null hypothesis that the two factors of a 2-dimensional contingency table are independent (no relationship) vs the alternative that they are not.</p>
<p>Consider first the hypothesis test for the original train/test data:</p>
<pre class="r"><code>item_frequency %&gt;% 
  select(count_train, count_test) %&gt;% 
  fisher.test(simulate.p.value = TRUE)</code></pre>
<pre><code>## 
##  Fisher&#39;s Exact Test for Count Data with simulated p-value (based on
##  2000 replicates)
## 
## data:  .
## p-value = 0.0004998
## alternative hypothesis: two.sided</code></pre>
<p>The p-value is very small indicating that there is sufficient evidence that the movie popularity distribution is dependent on the dataset (test or train).</p>
<p>Now consider the test for our re-sampled train/test data:</p>
<pre class="r"><code>item_frequency_new %&gt;% 
  select(count_train, count_test) %&gt;% 
  fisher.test(simulate.p.value = TRUE)</code></pre>
<pre><code>## 
##  Fisher&#39;s Exact Test for Count Data with simulated p-value (based on
##  2000 replicates)
## 
## data:  .
## p-value = 0.6112
## alternative hypothesis: two.sided</code></pre>
<p>In this case the p-value is large meaning that we fail to reject the hypothesis that the movie popularity distribution is independent of the dataset. In other words, we see a similar pattern in both the test and train data sets that we sampled. These results align with our expectation.</p>
<!-- ### Hypothesis testing of high dimensional (and sparse) discrete data -->
<!-- In a [previous blog post](https://amanda.rbind.io/2019/05/24/new-r-package-hddtest/) I introduced a new method for testing whether two high dimensional mutlinomial vectors have the same underlying probability vector. Compared to the $\chi^2$ test, this method is more robust in the presence of small values. The R method is available via the `hddtest` package available in the [AmandaRP/hddtest](https://github.com/AmandaRP/hddtest) GitHub repository. -->
<!-- ```{r class.source = "fold-show"} -->
<!-- #devtools::install_github("AmandaRP/hddtest", build = TRUE, build_opts = c("--no-resave-data", "--no-manual")) -->
<!-- library("hddtest") -->
<!-- ``` -->
<!-- We'll assume that the train and test vectors have an underlying multinomial distribution with parameters ($p_{train}$, $n_{train}$) and ($p_{test}$, $n_{test}$) respectively. (See the [Closing Thoughts](#closing) section at the end for a discussion about the multinomial assumption.) We'd like to test the null hypothesis that $p_{train} = p_{test}$ vs the althernative that they are not equal. To do this we might consider using the `multinom.test` function from the `hddtest` package. However, a simulation experiment shows that the [size](https://en.wikipedia.org/wiki/Size_(statistics)) of the test is not well controlled when the data is stratified by user (see the Appendix at the end of the article). In other words, the test is too sensitive.  -->
<!-- Alternatively, we can consider the null hypothesis that $p_{train}$ and $p_{test}$ are within some neighborhood, $\delta$ (vs the alternative that they are not). What value of $\delta$ should be used? Figure 3 below shows the p-value curves for various values of $\delta$, comparing multiple random test/train splits (teal) and also the provided test & train data (red). We won't actually perform the hypothesis test because we've now peaked at our data. However, you can see that the p-value curve for the provided data looks much different than those for the random test/train splits. -->
<!-- <details> -->
<!--   <summary>View code</summary> -->
<!-- </br>  -->
<!-- ```{r, fig.width=8, fig.height=3.5, message = FALSE, warning=FALSE, echo = TRUE, eval = FALSE, fig.cap='Delta in (0, 2800]. Inset image: Zoomed view of delta in (0, 5].'} -->
<!-- num_reps <- 50 -->
<!-- stratified <- TRUE -->
<!-- vecs2Test <- list(matrix(NA, num_reps, nrow(item_frequency)), matrix(NA, num_reps, nrow(item_frequency))) -->
<!-- for(i in 1:num_reps){ -->
<!--   if(stratified){ -->
<!--     test_sim <-  -->
<!--       data_full %>%  -->
<!--       group_by(user) %>% -->
<!--       slice_sample(prop = pct_test) %>% -->
<!--       ungroup() -->
<!--   }else{ -->
<!--     test_sim <-  -->
<!--       data_full %>%  -->
<!--       slice_sample(prop = pct_test)  -->
<!--   } -->
<!--   # Put remaining data in train: -->
<!--   train_sim <- anti_join(data_full, test_sim) -->
<!--   # Recreate our interaction counts for each item: -->
<!--   item_frequency_sim <-  -->
<!--     full_join( -->
<!--       train_sim %>% group_by(item) %>% count() %>% ungroup(), -->
<!--       test_sim  %>% group_by(item) %>% count() %>% ungroup(), -->
<!--       by = "item" -->
<!--     ) %>% -->
<!--     rename(count_train = n.x, count_test = n.y) %>% -->
<!--     replace_na(list(count_train = 0, count_test = 0)) -->
<!--   # Build a matrix of vectors to test -->
<!--   vecs2Test[[1]][i, ] <- item_frequency_sim$count_train -->
<!--   vecs2Test[[2]][i, ] <- item_frequency_sim$count_test -->
<!-- } -->
<!-- #Perform the test: -->
<!-- delta = c(.00000001, .00001, .0001, .001, .01, .1, .5, .75, seq(from=1,to=2800, by = 100) ) -->
<!-- result_sampled <- vecs2Test %>% multinom.neighborhood.test(delta = delta) -->
<!-- p_sampled <- result_sampled$pvalue_delta -->
<!-- result_original <- multinom.neighborhood.test(x = item_frequency$count_train, y = item_frequency$count_test, delta = delta) -->
<!-- p_original <- result_original$pvalue_delta -->
<!-- dat1 <- data.frame(delta=delta, sampled = t(p_sampled), original = t(p_original)) %>% -->
<!--   gather(-delta, key = "replication", value = pvalue) %>%  -->
<!--   mutate("hypothesis" = str_extract(replication,"\\w{1,}")) -->
<!-- p1 <- ggplot(dat1, aes(x = delta, y = pvalue, group = replication, colour = hypothesis)) +  -->
<!--   geom_line() + -->
<!--   geom_hline(yintercept = 0.05, linetype = "dotted") + -->
<!--   annotate("text", x = 300, y = .09, label = "alpha = 0.05") + -->
<!--   labs(y = "p-value", title = "P-Value Curves for Original and Sampled Train/Test Splits", color = "Dataset") +  -->
<!--   #geom_curve(aes(x = 75, y = .71, xend = 61, yend = .6), curvature = -0.3, arrow = arrow(length=unit(2,"mm")), color = "darkgrey") + -->
<!--   theme_classic() + -->
<!--   theme(title = element_text(face = "bold", size = 14), -->
<!--         panel.grid = element_blank()) -->
<!-- delta = c(.00000001, .00001, .0001, .001, .01, .1, .5, .75, 1:5) -->
<!-- result_sampled <- vecs2Test %>% multinom.neighborhood.test(delta = delta) -->
<!-- p_sampled <- result_sampled$pvalue_delta -->
<!-- result_original <- multinom.neighborhood.test(x = item_frequency$count_train, y = item_frequency$count_test, delta = delta) -->
<!-- p_original <- result_original$pvalue_delta -->
<!-- dat2 <- data.frame(delta=delta, sampled = t(p_sampled), original = t(p_original)) %>% -->
<!--   gather(-delta, key = "replication", value = pvalue) %>%  -->
<!--   mutate("hypothesis" = str_extract(replication,"\\w{1,}")) -->
<!-- p2 <- ggplot(dat2, aes(x = delta, y = pvalue, group = replication, colour = hypothesis)) +  -->
<!--   geom_line() + -->
<!--   labs(y = element_blank()) +  -->
<!--   #geom_curve(aes(x = 75, y = .71, xend = 61, yend = .6), curvature = -0.3, arrow = arrow(length=unit(2,"mm")), color = "darkgrey") + -->
<!--   theme_classic() + -->
<!--   theme(title = element_text(face = "bold", size = 14), -->
<!--         panel.grid = element_blank(), -->
<!--         legend.title = element_blank(), -->
<!--         legend.position = "none" -->
<!--         ) -->
<!-- ggdraw(p1) + -->
<!--   draw_plot(p2, .25, .25, .4, .5)  -->
<!-- ``` -->
<!-- </details> -->
<!-- ```{r, fig.width=8, fig.height=3.5, message = FALSE, warning=FALSE, echo = FALSE, fig.cap='Delta in (0, 2800]. Inset image: Zoomed view of delta in (0, 5].'} -->
<!-- num_reps <- 50 -->
<!-- stratified <- TRUE -->
<!-- vecs2Test <- list(matrix(NA, num_reps, nrow(item_frequency)), matrix(NA, num_reps, nrow(item_frequency))) -->
<!-- for(i in 1:num_reps){ -->
<!--   if(stratified){ -->
<!--     test_sim <-  -->
<!--       data_full %>%  -->
<!--       group_by(user) %>% -->
<!--       slice_sample(prop = pct_test) %>% -->
<!--       ungroup() -->
<!--   }else{ -->
<!--     test_sim <-  -->
<!--       data_full %>%  -->
<!--       slice_sample(prop = pct_test)  -->
<!--   } -->
<!--   # Put remaining data in train: -->
<!--   train_sim <- anti_join(data_full, test_sim) -->
<!--   # Recreate our interaction counts for each item: -->
<!--   item_frequency_sim <-  -->
<!--     full_join( -->
<!--       train_sim %>% group_by(item) %>% count() %>% ungroup(), -->
<!--       test_sim  %>% group_by(item) %>% count() %>% ungroup(), -->
<!--       by = "item" -->
<!--     ) %>% -->
<!--     rename(count_train = n.x, count_test = n.y) %>% -->
<!--     replace_na(list(count_train = 0, count_test = 0)) -->
<!--   # Build a matrix of vectors to test -->
<!--   vecs2Test[[1]][i, ] <- item_frequency_sim$count_train -->
<!--   vecs2Test[[2]][i, ] <- item_frequency_sim$count_test -->
<!-- } -->
<!-- #Perform the test: -->
<!-- delta = c(.00000001, .00001, .0001, .001, .01, .1, .5, .75, seq(from=1,to=2800, by = 100) ) -->
<!-- result_sampled <- vecs2Test %>% multinom.neighborhood.test(delta = delta) -->
<!-- p_sampled <- result_sampled$pvalue_delta -->
<!-- result_original <- multinom.neighborhood.test(x = item_frequency$count_train, y = item_frequency$count_test, delta = delta) -->
<!-- p_original <- result_original$pvalue_delta -->
<!-- dat1 <- data.frame(delta=delta, sampled = t(p_sampled), original = t(p_original)) %>% -->
<!--   gather(-delta, key = "replication", value = pvalue) %>%  -->
<!--   mutate("hypothesis" = str_extract(replication,"\\w{1,}")) -->
<!-- p1 <- ggplot(dat1, aes(x = delta, y = pvalue, group = replication, colour = hypothesis)) +  -->
<!--   geom_line() + -->
<!--   geom_hline(yintercept = 0.05, linetype = "dotted") + -->
<!--   annotate("text", x = 300, y = .09, label = "alpha = 0.05") + -->
<!--   labs(y = "p-value", title = "P-Value Curves for Original and Sampled Train/Test Splits", color = "Dataset") +  -->
<!--   #geom_curve(aes(x = 75, y = .71, xend = 61, yend = .6), curvature = -0.3, arrow = arrow(length=unit(2,"mm")), color = "darkgrey") + -->
<!--   theme_classic() + -->
<!--   theme(title = element_text(face = "bold", size = 14), -->
<!--         panel.grid = element_blank()) -->
<!-- delta = c(.00000001, .00001, .0001, .001, .01, .1, .5, .75, 1:5) -->
<!-- result_sampled <- vecs2Test %>% multinom.neighborhood.test(delta = delta) -->
<!-- p_sampled <- result_sampled$pvalue_delta -->
<!-- result_original <- multinom.neighborhood.test(x = item_frequency$count_train, y = item_frequency$count_test, delta = delta) -->
<!-- p_original <- result_original$pvalue_delta -->
<!-- dat2 <- data.frame(delta=delta, sampled = t(p_sampled), original = t(p_original)) %>% -->
<!--   gather(-delta, key = "replication", value = pvalue) %>%  -->
<!--   mutate("hypothesis" = str_extract(replication,"\\w{1,}")) -->
<!-- p2 <- ggplot(dat2, aes(x = delta, y = pvalue, group = replication, colour = hypothesis)) +  -->
<!--   geom_line() + -->
<!--   labs(y = element_blank()) +  -->
<!--   #geom_curve(aes(x = 75, y = .71, xend = 61, yend = .6), curvature = -0.3, arrow = arrow(length=unit(2,"mm")), color = "darkgrey") + -->
<!--   theme_classic() + -->
<!--   theme(title = element_text(face = "bold", size = 14), -->
<!--         panel.grid = element_blank(), -->
<!--         legend.title = element_blank(), -->
<!--         legend.position = "none" -->
<!--         ) -->
<!-- ggdraw(p1) + -->
<!--   draw_plot(p2, .25, .25, .4, .5)  -->
<!-- ``` -->
</div>
</div>
<div id="closing" class="section level2">
<h2>Closing Thoughts</h2>
<p>Using a few methods (vizualization, Gini index, and hypothesis testing) we observed that the provided test data set did not follow the same popularity distribution as the training set.</p>
<p>Should we always expect our train and test data to have the same distribution? What if the test/train split were based on time (i.e. we use earlier data to train the model and use the most recent data to test). This might be an interesting experiment for a future blog post or a class exercise.</p>
<!-- One might also argue that we should not assume a multinomial distribution for the item counts as we did for the hypothesis testing. If there is correlation between the items (e.g. if the first movie in a series was popular, we might expect the sequel to also do well), then the Dirichlet-multinomial distribution may be a better assumption. In this case, a different hypothesis tests is required. -->
<p>If you would like to provide feedback on this blog post, you can contact me via Twitter (DM me <span class="citation">@DrAmandaRP</span>). Thanks for reading!</p>
<!-- <details> -->
<!--   <summary>**Appendix**: Size Study</summary> -->
<!-- To understand the size of the hypothesis test (i.e. the `multinom.test` from the `hddtest` package) for the application of comparing the test and training datasets, let's run a simulation sampling mulitple test/train splits.  -->
<!-- ```{r eval = FALSE, class.source = 'fold-show'} -->
<!-- data_full_sim <- data_full -->
<!-- alpha <- 0.05 -->
<!-- num_reps <- 10000 -->
<!-- stratified <- FALSE -->
<!-- result <- array(NA, dim = num_reps) -->
<!-- for(i in 1:num_reps){ -->
<!--   if(stratified){ -->
<!--     test_sim <-  -->
<!--       data_full_sim %>%  -->
<!--       group_by(user) %>% -->
<!--       slice_sample(prop = pct_test) %>% -->
<!--       ungroup() -->
<!--   }else{ -->
<!--     test_sim <-  -->
<!--       data_full_sim %>%  -->
<!--       slice_sample(prop = pct_test)  -->
<!--   } -->
<!--   # Put remaining data in train: -->
<!--   train_sim <- anti_join(data_full_sim, test_sim) -->
<!--   # Recreate our interaction counts for each item: -->
<!--   item_frequency_sim <-  -->
<!--     full_join( -->
<!--       train_sim %>% group_by(item) %>% count() %>% ungroup(), -->
<!--       test_sim  %>% group_by(item) %>% count() %>% ungroup(), -->
<!--       by = "item" -->
<!--     ) %>% -->
<!--     rename(count_train = n.x, count_test = n.y) %>% -->
<!--     replace_na(list(count_train = 0, count_test = 0)) -->
<!--   result[i] <- multinom.test(item_frequency_sim$count_train, item_frequency_sim$count_test)$pvalue  -->
<!-- } -->
<!-- mean(result <= alpha) -->
<!-- # size for stratified data: 0.2351 (using 10K reps). Not controlling size well.  -->
<!-- # size for non-stratified data: 0.0517 (using 10K reps) -->
<!-- ``` -->
<!-- Using 10K replications and $\alpha = 0.05$, the size of the test on the stratified sampled data is 0.2351 (not well controlled). However, the size of the test for the non-stratified sampled data is 0.0517, which is much better. In other words, the test is too sensitive for the stratified sampled dataset. -->
<!-- </details>  -->
</div>
